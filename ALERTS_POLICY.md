# Clawmetry Alert Policy v1 (확정)

## 목적
- `clawmetry` 로그/헬스 이상을 **알림봇(alerts 계정)**으로 짧고 정확하게 전달한다.
- 노이즈를 줄이고, 복구 여부까지 한 번에 확인 가능하게 한다.

## 알림 등급

### P1 (즉시 알림)
1. `http://127.0.0.1:8900` 헬스체크 **2회 연속 실패**
2. `launchctl` 서비스가 비정상 상태(미로드/비실행)
3. `clawmetry.error.log`에 치명 패턴 감지
   - `Traceback`, `Exception`, `CRITICAL`, `fatal`, `address already in use`

### P2 (집계 알림)
1. 동일 오류가 1시간 내 반복(3회 이상)
2. 응답 지연/간헐 장애가 반복되지만 자동복구되는 상태

## 노이즈 억제 규칙
1. **중복 억제**: 같은 에러 시그니처는 30분 쿨다운
2. **집계 전송**: P2는 즉시가 아니라 1시간 집계 1회
3. **무시 패턴**: 개발서버 경고/일반 info 로그는 제외

## 복구 알림 규칙
- 장애 알림 발송 후, 동일 항목이 **연속 2회 정상**이면 `복구됨` 알림 1회 발송
- 복구 알림에도 장애 원인 키워드를 함께 첨부

## 알림 포맷 (고정)
- 1~4줄
- 형식:
  1) 상태(🔴 장애 / 🟡 경고 / 🟢 복구)
  2) 원인(시그니처)
  3) 영향(모니터링/대시보드/크론)
  4) 다음 액션(재시작/로그확인)

## 채널/대상
- channel: `telegram`
- accountId: `alerts`
- target: `<TELEGRAM_CHAT_ID>` (예: 개인 DM chat id)

## 운영 주기 (권장)
- 헬스체크: 5분
- 로그 스캔: 10분
- 집계 리포트(P2): 1시간
- **운영 요약(이상 시만): 하루 2회(09:30 / 21:30 KST)**
  - 최근 12시간 기준으로 이상(이벤트/활성 incident/에러 잡)이 있을 때만 전송

## 변경 규칙
- 임계치/쿨다운 변경은 파트너 승인 후 반영
